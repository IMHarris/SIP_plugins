$def with(settings, runtime_values,records)

<!-- Edit: Replace "proto_vals" with settings values for your plugin if used-->

$var title: $_(u'SIP Flow Log')
$var page: flowlog
$code:
	snames = gv.snames
	log_option = ""
	if u"chk-enable-logging" in settings.keys():
		log_state = _(u"enabled")
	else:
		log_state = _(u"disabled")
	def formatTime(t):
		if gv.sd['tf']:
			return t
		else:
			hour = int(t[0:2])
			newhour = hour
			if hour == 0:
				newhour = 12
			if hour > 12:
				newhour = hour-12
			return str(newhour) + t[2:] + (" am" if hour<12 else " pm")
	if u"text-max-log-entries" in settings.keys():
	    textmax = settings["text-max-log-entries"]
	    if textmax.isnumeric():
	        max_log_entries = int(settings["text-max-log-entries"])
	    else:
	        max_log_entries = 0
	else:
	    max_log_entries = 0
    

<script>
    // Initialize behaviors
    jQuery(document).ready(function(){
        jQuery("button#nRefresh").click(function(){
            window.location = "/flow-log";
        });
        jQuery("button#nDeleteAll").click(function(){
            jQuery("form#df").submit();
        });
        jQuery("button#settingsButton").click(function(){
            window.open("flow-settings", "_blank");
        });
    });

</script>

<script>

    document.getElementByName("text-master-sensor-addr").innerHTML = "Hi";
    
</script>
<noscript>Sorry, your browser does not support JavaScript!</noscript>


<div id="plugin">
    <div class="title">Flow <!--Edit: User page heading, Make relevant to your plugin-->
        <button class="execute" id="settingsButton" type="button" >$_(u'Flow Settings')</button>
        <button class="execute" id="docButton" type="button" >$_(u'Help')</button></div>


    <p>$_(u' ')</p>
    <form id="pluginForm" action="${'/flow-save'}" method="get"> <!--Edit: Replace "proto-save" with URL of plugin's class for saving settings-->
        <header>
            <h3>Flow info</h3>
        </header>
        
        <table class="optionList">
            <tr>
                <!--<td style="font-size:2em;text-align:left" > <p id='lbl-flow' value='27 Gallons/hour '></p></td>-->
                <td id='lbl-flow' style="font-size:2em;text-align:left" >  </td>
                <td id="lbl-cal-btn" rowspan="2"> <button type="button" id="btn-calibrate" background-color= #AAA hidden>Start Calibration</button></td>
            </tr>
            <tr>
                <td id="lbl-use" style="font-size:1.25em;text-align:left"></td>
            </tr>
            <tr>
                <td id="lbl-valves" style="font-size:1.25em;text-align:left"></td>
            </tr>
        </table><br>
        
    </form>

</div>

<div id="log">
    <header>
        <h3>${u'Flow log (' + log_state + u')'}</h3>
    </header>
    <p>$_(u'Total number of records: ')${len(records)} (${_(u"no") if max_log_entries == 0 else str(max_log_entries)}$_(u' limit'))</p>
    <p>$_(u'Download log as ')<a href="/wfl">csv</a>.</p>

    <table class="logList">
    	<thead>
        <tr class="log_rec">
            <th>$_(u'Date')</th>
            <th>$_(u'Start Time')</th>
            <th>$_(u'Duration')</th>
            <th>$_(u'Stations')</th>
            <th>$_(u'Usage')</th>
            <th>$_(u'Units')</th>
        </tr>
        </thead>

        <tbody>
        $ odd = 1
        $for r in records:
            $ event = r #  ast.literal_eval(json.loads(r))
            <tr class="log_rec ${'odd' if odd else 'even'}">
                <td>${event["date"]}</td>
                <td>${formatTime(event["start"])}</td>
                <td>${event["duration"]}</td>
                <td>${event["stations"]}</td>
                <td>${str(event["usage"])}</td>
                <td>${event["measure"]}</td>
            </tr>
            $ odd = 1 - odd
        </tbody>
    </table>

</div>

<br>

<script>   
    //This code polls the server for flow rate    
    
    // User configuration variables
    var href = window.location.href
    var apiURL = href.substr(0, href.lastIndexOf("/") + 1) + "flow-data" //page name delivering flow info in JSON
    const updateInterval = 3000  //flow info update frequency in milliseconds
    
    //Create a request variable and assign a new XMLHttpRequest object to it.
    var request = new XMLHttpRequest()
    
    function fnPostFlow(flowData, arg) {
        //Determines when the polling should stop based on the count of n
        //document.getElementById("lbl-flow").textContent = String(flowData.pulse_rate) + " hi";
        if (arg == "pulserate") {
            document.getElementById("lbl-flow").textContent = String(flowData.pulse_rate) + " pulses/second";
        } else if (arg == "flowrate") {
            document.getElementById("lbl-flow").textContent = String(flowData.flow_rate) + " " + flowData.volume_measure;
            document.getElementById("lbl-use").textContent = String(flowData.water_use);
            document.getElementById("lbl-valves").textContent = String(flowData.valve_status);
        }
    };
    
    request.onreadystatechange = function() {
        //function called when XHR data is loaded
        if (this.readyState == 4 && this.status == 200) {
            var flowData = JSON.parse(this.responseText);

            
            if (calibrationMode) {             
                if (isCalibrating) {
                    if (resetCalibration) {
                        // Start calibration button just pressed. Check again to ensure water has stopped
                        // before initating calibration. When it has, reset the pulse start value and tell
                        // the user to begin.
                        if (flowData.pulse_rate == 0){
                            // Button was just pressed and water is not flowing. Tell user to start water flow
                            pulseStartValue = flowData.total_pulses;
                            resetCalibration = false;
                            document.getElementById("btn-calibrate").disabled = true;
                            document.getElementById("lbl-flow").textContent = "Ready";
                            document.getElementById("lbl-valves").textContent = "Start water flow into container";
                        } else {
                            // Button has been pressed, but water is flowing. Need to wait for water flow to stop
                            fnPostFlow(flowData,"pulserate");
                            document.getElementById("btn-calibrate").disabled = true;
                            document.getElementById("lbl-valves").textContent = "Cannot start until flow = 0";
                        }
                    } else if (flowData.total_pulses - pulseStartValue > 0) {
                        //user has started water flow
                        document.getElementById("lbl-flow").textContent = String(Math.round((flowData.total_pulses  - pulseStartValue)*10)/10) + " pulses";
                        document.getElementById("lbl-valves").textContent = String(flowData.pulse_rate) + " pulses/sec";
                        if (flowData.pulse_rate > 0) {
                            document.getElementById("btn-calibrate").innerHTML = "Restart Calibration";
                            document.getElementById("btn-calibrate").disabled = true;
                        } else {
                            document.getElementById("btn-calibrate").disabled = false;
                        }              
                    } 
                } else {
                    // we're in calibration mode, but calibration hasn't started yet (button not yet pressed)
                    //need to check that flow=0, so that we can enable the start button
                    if (flowData.pulse_rate > 0) {
                         fnPostFlow(flowData,"pulserate");
                         document.getElementById("btn-calibrate").disabled = true;
                         document.getElementById("lbl-valves").textContent = "Cannot start until flow = 0";
                     } else {
                         fnPostFlow(flowData,"pulserate");
                         document.getElementById("lbl-valves").textContent = "Ready to start";
                         document.getElementById("btn-calibrate").disabled = false;                    
                     }     
                }
                
            } else {            
                // We are in the default mode.  Post the flow information
                fnPostFlow(flowData,"flowrate");
            }
        }
    };

    // Open a new connection, using the GET request on the URL endpoint
    request.open('GET', apiURL, true);

    async function poll(fn, fnCondition, milli) {
         // This function drives the polling
         let result = await fn(-1);
         while (fnCondition(result)) {
             await wait(milli);
             result = await fn(result);
         }
         return result;
    }

    function wait(msec) {
        return new Promise(resolve => {
        setTimeout(resolve, msec);
        });
    } 

    function fnGet(n = 0) {
        // Sends the GET request to the server to get the flow info
        n++
        request.open('GET', apiURL, true)
        request.send()
        return n;
    }

    function fnCondition(n = 0) {
        //Determines when the polling should stop based on the count of n
        if (n >= 1000) {
            return false;
        } else {
            return true;
        }
    }
    
    // Let the polling of the server for flow info begin!
    poll(fnGet, fnCondition, updateInterval);
    
    //Code for flow calibration mode
    
    // btn-calibrate sets pulses to zero and starts the counting
    isCalibrating=false;
    resetCalibration = false;
    document.getElementById("btn-calibrate").addEventListener("click", fnCalibrate);
    
    function fnCalibrate() {
        // Start the calibration
        resetCalibration = true;
        isCalibrating = true;
        document.getElementById("lbl-flow").textContent = "Wait";
        document.getElementById("btn-calibrate").disabled = true;    
    }
    
    calibrationMode = false;
    function fnCalibrationMode() {
        // Turns calibration mode on/off
        if (false) {
            // Turn calibration mode on
            calibrationMode = true;
            document.getElementById("lbl-flow").textContent = "Wait";
            document.getElementById("btn-calibrate").disabled = true;
            document.getElementById("btn-calibrate").hidden = false;
        } else {
            // Turn calibration mode off
            calibrationMode = false;
            isCalibrating = false
            document.getElementById("btn-calibrate").hidden = true;
            document.getElementById("btn-calibrate").innerHTML = "Start Calibration";
        }    
    }         

</script>

